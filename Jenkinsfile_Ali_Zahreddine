pipeline {
  agent any
  environment { VENV_DIR = ".venv" }
  options { timestamps() }

  stages {

    stage('Environment Prep') {
      steps {
        dir('jenkins_project') {
          bat '''
            rem === Resolve a Python interpreter for the Jenkins service ===
            set "PY_EXE="
            for %%P in (
              "C:\\Windows\\py.exe"
              "C:\\Program Files\\Python312\\python.exe"
              "C:\\Program Files\\Python311\\python.exe"
              "%USERPROFILE%\\AppData\\Local\\Programs\\Python\\Python312\\python.exe"
              "%USERPROFILE%\\anaconda3\\python.exe"
            ) do (
              if not defined PY_EXE if exist %%~P set "PY_EXE=%%~P"
            )

            if not defined PY_EXE (
              echo ERROR: No system Python found for Jenkins service.
              exit /b 1
            )

            "%PY_EXE%" --version

            if not exist %VENV_DIR% ("%PY_EXE%" -m venv %VENV_DIR%)
            call ".\\%VENV_DIR%\\Scripts\\python" -m pip install --upgrade pip
            call ".\\%VENV_DIR%\\Scripts\\python" -m pip install -r requirements.txt

            if not exist diagnostics mkdir diagnostics
            if not exist release mkdir release
          '''
        }
      }
    }

    stage('Style Check') {
      steps {
        dir('jenkins_project') {
          script {
            def lintCmd = '''
              ".\\%VENV_DIR%\\Scripts\\flake8" app.py 1> diagnostics\\lint_report.log 2>&1
            '''
            def rc = bat(returnStatus: true, script: lintCmd)
            echo "flake8 exit code = ${rc}"
            if (rc != 0) {
              currentBuild.result = 'UNSTABLE'
              echo 'Lint findings logged to diagnostics\\lint_report.log (marking UNSTABLE, continuing).'
            }
          }
        }
      }
    }

    stage('Unit Tests') {
      steps {
        dir('jenkins_project') {
          bat '''
            ".\\%VENV_DIR%\\Scripts\\pytest" -q --junitxml=diagnostics\\pytest-results.xml
          '''
        }
      }
    }

    stage('Coverage Metrics') {
      steps {
        dir('jenkins_project') {
          script {
            def coverageCmd = '''
              ".\\%VENV_DIR%\\Scripts\\coverage" run -m pytest -q
              ".\\%VENV_DIR%\\Scripts\\coverage" xml -o diagnostics\\coverage-metrics.xml
              ".\\%VENV_DIR%\\Scripts\\coverage" report -m > diagnostics\\coverage-summary.txt
            '''
            def rc = bat(returnStatus: true, script: coverageCmd)
            echo "coverage step exit code = ${rc}"
            if (rc != 0) {
              currentBuild.result = 'UNSTABLE'
              echo 'Coverage step had issues (marking UNSTABLE, continuing).'
            }
          }
        }
      }
    }

    stage('Static Security Scan') {
      steps {
        dir('jenkins_project') {
          script {
            def rc = bat(returnStatus: true, script: '''
              ".\\%VENV_DIR%\\Scripts\\bandit" -r . --severity-level high --confidence-level high -f json -o diagnostics\\security-scan.json
            ''')
            echo "bandit exit code = ${rc} (ignored for build status)"
          }
        }
      }
    }

    stage('Package Output') {
      steps {
        dir('jenkins_project') {
          bat '''
            if not exist release mkdir release
            ".\\%VENV_DIR%\\Scripts\\python" app.py > release\\runtime-output.log
          '''
          powershell 'Compress-Archive -Path app.py, requirements.txt -DestinationPath release\\application_bundle.zip -Force'
        }
      }
    }
  }

  post {
    always {
      dir('jenkins_project') {
        archiveArtifacts artifacts: 'diagnostics/*.xml,diagnostics/*.txt,diagnostics/*.log,diagnostics/*.json,release/**', fingerprint: true
      }
      cleanWs()
    }
  }
}
